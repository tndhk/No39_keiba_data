# ML予測機能設計

## 概要

競馬レース分析に機械学習による着順予測機能を追加する。
既存の`analyze`コマンドに統合し、各馬の「3着以内確率」とランキングを出力する。

## 要件

- 予測対象: 着順予測（1着〜3着に入る馬）
- アウトプット: 確率 + ランキングの両方
- モデル: LightGBM（二値分類）
- 特徴量: 7つの分析ファクター + 生データ
- 評価指標: Precision@K（上位馬の精度重視）
- 運用: 毎回学習 + 推論（手動運用、後から自動化検討）

## アーキテクチャ

```
┌─────────────────────────────────────────────────────────┐
│                    analyze コマンド                      │
├─────────────────────────────────────────────────────────┤
│  1. 学習データ準備                                       │
│     - DBから過去レース結果を取得                          │
│     - 特徴量を生成（7ファクター + 生データ）              │
│     - ラベル付与（3着以内=1, 4着以下=0）                  │
├─────────────────────────────────────────────────────────┤
│  2. モデル学習                                           │
│     - LightGBM二値分類器を学習                           │
│     - 対象レース以前のデータのみ使用（リーク防止）        │
├─────────────────────────────────────────────────────────┤
│  3. 推論                                                 │
│     - 対象レースの各馬の特徴量を生成                     │
│     - 3着以内確率を予測                                  │
├─────────────────────────────────────────────────────────┤
│  4. 出力                                                 │
│     - 既存スコア表 + 予測確率列 + 予測ランキング          │
└─────────────────────────────────────────────────────────┘
```

## 特徴量設計

### 分析ファクター由来（7つ）

| 特徴量名 | 説明 |
|---------|------|
| past_results_score | 過去成績スコア |
| course_fit_score | コース適性スコア |
| time_index_score | タイム指数スコア |
| last_3f_score | 上がり3Fスコア |
| popularity_score | 人気スコア |
| pedigree_score | 血統スコア |
| running_style_score | 脚質スコア |

### 生データ由来（8つ）

| 特徴量名 | 説明 |
|---------|------|
| odds | 単勝オッズ |
| popularity | 人気順 |
| weight | 馬体重 |
| weight_diff | 馬体重増減 |
| age | 馬齢 |
| impost | 斤量 |
| horse_number | 馬番 |
| field_size | 出走頭数 |

### 派生特徴量（4つ）

| 特徴量名 | 説明 |
|---------|------|
| win_rate | 過去勝率（勝利数/出走数） |
| top3_rate | 過去3着内率 |
| avg_finish_position | 平均着順 |
| days_since_last_race | 前走からの間隔（日数） |

合計: 最大19特徴量

## モデル学習・推論フロー

### 学習フロー

1. 学習データ取得
   - 対象レース日より前の全レース結果をDBから取得
   - 最低100レース以上あることを確認（なければ警告）

2. 特徴量生成
   - 各出走馬について19特徴量を計算
   - 欠損値は-1で埋める（LightGBMは欠損を扱える）

3. ラベル付与
   - finish_position <= 3 → 1（3着以内）
   - finish_position > 3 → 0（4着以下）
   - finish_position = 0（中止等）→ 除外

4. LightGBM学習
   - binary分類、logloss目的関数
   - 5-fold CV で過学習チェック（ログ出力のみ）
   - 最終モデルは全学習データで再学習

### 推論フロー

1. 対象レースの出走馬を取得
2. 各馬の特徴量を生成（学習時と同じ処理）
3. model.predict_proba() で3着以内確率を取得
4. 確率の高い順にランキング付け

## CLI統合

### コマンド

```bash
keiba analyze --db keiba.db --date 2024-01-06 --venue 中山
```

- ML予測はデフォルトで実行
- `--no-predict` フラグ: ML予測をスキップしたい場合のみ指定

### 出力形式

```
======================================================================
2024-01-06 中山 11R 有馬記念 芝2500m
======================================================================

【ML予測】学習データ: 2,345レース / 対象馬: 16頭
----------------------------------------------------------------------
予測  馬番  馬名          3着内確率   総合   過去   適性   タイム  上がり  人気
----------------------------------------------------------------------
  1     5   イクイノックス   78.2%    85.2   90.0   80.0   82.0   88.0   86.0
  2     3   ドウデュース     65.4%    78.5   75.0   82.0   78.0   80.0   77.5
  3     8   タイトルホルダー 52.1%    72.0   70.0   75.0   74.0   68.0   75.0
  ...
----------------------------------------------------------------------
※ 確率50%以上: 3頭
```

## 評価指標

### メイン指標: Precision@K

「予測上位K頭のうち、実際に3着以内だった馬の割合」

```
例: 予測上位3頭を推奨した場合
- 推奨馬A → 2着（的中）
- 推奨馬B → 5着（外れ）
- 推奨馬C → 1着（的中）
→ Precision@3 = 2/3 = 66.7%
```

### 評価出力（学習時にログ表示）

```
【モデル評価】5-fold CV結果
----------------------------------------------------------------------
  Precision@1: 32.5%
  Precision@3: 58.2%
  AUC-ROC:     0.72
  Log Loss:    0.58
----------------------------------------------------------------------
```

## ファイル構成

### 新規作成ファイル

```
keiba/
├── ml/
│   ├── __init__.py
│   ├── feature_builder.py    # 特徴量生成（19特徴量）
│   ├── trainer.py            # LightGBM学習・CV評価
│   └── predictor.py          # 推論・確率出力
```

### 修正ファイル

```
keiba/
├── cli.py                    # analyzeコマンドにML予測統合
└── pyproject.toml            # lightgbm追加
```

### 依存関係追加

```
lightgbm>=4.0.0
scikit-learn>=1.3.0
```

### テストファイル

```
tests/
├── ml/
│   ├── test_feature_builder.py
│   ├── test_trainer.py
│   └── test_predictor.py
```

## 将来の拡張

- モデルの永続化（学習済みモデルの保存・読み込み）
- 定期的な自動再学習
- ランキング学習（LambdaRank）への移行
- 特徴量重要度の可視化
- 回収率シミュレーション機能
