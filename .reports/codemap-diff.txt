# Codemap Diff Report
Generated: 2026-01-25

## Summary

Overall Change Percentage: ~20%
Status: AUTO-APPROVED (under 30% threshold)

## Changes by File

### docs/CODEMAPS/architecture.md

Updated Sections:
1. Module Dependencies (10 lines modified)
   - Added joblib dependency to ml/trainer.py
   - Added services/prediction_service.py dependencies detail
   - Added models/entry.py to fukusho_simulator.py dependencies

2. Data Flow - Real-time Prediction Pipeline (3 lines modified)
   - Added "_calculate_combined_score() (幾何平均)" to PredictionService flow
   - Updated output description to include combined_score

3. Data Flow - NEW: Train Pipeline (12 lines added)
   - Added complete train command data flow diagram

4. External Dependencies (2 lines added)
   - Added joblib and numpy to dependency table

5. CLI Helper Functions (2 lines added)
   - Added _build_training_data()
   - Added _calculate_past_stats()

6. NEW: Model Configuration section (15 lines added)
   - Trainer Parameters table (Normal vs Lightweight mode)
   - Model Storage details (format, path, naming)

Lines Added: ~30
Lines Modified: ~15
Change Percentage: ~12%

### docs/CODEMAPS/backend.md

Status: NEW FILE CREATED

Content:
1. Overview (~10 lines)
2. CLI structure and commands (~100 lines)
   - Entry point documentation
   - Command list
   - SQLAlchemyRaceResultRepository class
   - Helper functions table with line numbers

3. Services documentation (~80 lines)
   - PredictionService structure
   - Combined Score calculation formula
   - RaceResultRepository protocol

4. Scrapers documentation (~60 lines)
   - Directory structure
   - Class documentation for all 4 scrapers
   - Method signatures

5. Database Layer (~20 lines)
   - db.py functions

6. ML Layer (~50 lines)
   - Trainer class with mode params
   - Model utils function

7. Backtest Layer (~40 lines)
   - FukushoSimulator
   - BacktestEngine

8. Configuration (~30 lines)
   - weights.py
   - pedigree_master.py reference

9. Request/Response Flow (~30 lines)
   - predict command flow
   - train command flow

10. Error Handling (~15 lines)

Total Lines: ~435
Change Percentage: N/A (new file)

### docs/CODEMAPS/data.md

Updated Sections:
1. Freshness timestamp updated
   - Previous: 2026-01-24 (FukushoSimulator data structures)
   - Current: 2026-01-25 (PredictionResult.combined_score, model storage)

2. ER Diagram (format improved)
   - Changed from Unicode box to ASCII box drawing
   - Added clarity to table relationships

3. NEW: Service Layer Data Structures (~35 lines added)
   - PredictionResult with combined_score field
   - Combined Score Formula documentation

4. Entry DTOs section (~35 lines added)
   - RaceEntry dataclass
   - ShutubaData dataclass

5. NEW: Model Storage section (~30 lines added)
   - File format documentation
   - Model loading code
   - Model saving code

6. FukushoSimulator description updated
   - Added "PredictionServiceを使用して7因子スコアとML予測を組み合わせて予測"

Lines Added: ~100
Lines Modified: ~10
Change Percentage: ~18%

## Source Code Changes Referenced

### keiba/services/prediction_service.py
Key changes reflected in codemap:
- PredictionResult.combined_score field (line 30)
- _calculate_combined_score() method (lines 333-354)
- Sorting by combined_score (lines 171-175)

### keiba/ml/trainer.py
Key changes reflected in codemap:
- save_model() method (lines 165-189)
- Mode parameters (_NORMAL_PARAMS, _LIGHTWEIGHT_PARAMS)

### keiba/ml/model_utils.py
New file documented:
- find_latest_model() function (lines 6-27)

### keiba/cli.py
Key changes reflected in codemap:
- train command (lines 2182-2250)
- _print_prediction_table combined_score display (lines 1266-1328)

### keiba/backtest/fukusho_simulator.py
Changes reflected in codemap:
- PredictionService integration (lines 229-231)
- _BacktestRaceResultRepository class (lines 19-89)

## Verification

All referenced files exist:
[x] keiba/services/prediction_service.py (combined_score)
[x] keiba/ml/trainer.py (save_model, mode params)
[x] keiba/ml/model_utils.py (find_latest_model)
[x] keiba/cli.py (train command, _print_prediction_table)
[x] keiba/backtest/fukusho_simulator.py (PredictionService integration)
[x] keiba/models/entry.py (RaceEntry, ShutubaData)
[x] keiba/db.py (get_engine, get_session, init_db)
[x] keiba/constants.py (JRA_COURSE_CODES)

## New Test Files Since Last Update

| File | Purpose |
|------|---------|
| tests/cli/test_train_command.py | train command tests |
| tests/ml/test_model_utils.py | model_utils tests |

## Freshness Timestamps

| File | Previous | Current |
|------|----------|---------|
| architecture.md | 2026-01-25 | 2026-01-25 (updated) |
| backend.md | N/A | 2026-01-25 (created) |
| data.md | 2026-01-24 | 2026-01-25 (updated) |

## Quality Checklist

- [x] Codemaps generated from actual code
- [x] All file paths verified to exist
- [x] Code examples match source
- [x] Freshness timestamps updated
- [x] No obsolete references
- [x] Consistent markdown formatting

---
End of Report
